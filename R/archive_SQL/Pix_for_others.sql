-- Pix for Others
-- This will be a combination of 8 queries 
-- (Sender or Receiver)x(send to or received from: Person or Firm)x(send to or received from: Inside the municipality, Outside the municipality, intra municipality)



-- Query 1: id mandando dinheiro (Sender - id_sender) 
--          para pessoa f?sica (Person - person_or_firm_receiver == person) 
--          dentro do seu munic?pio (Inside - mun_id_sender == mun_id_receiver)

SELECT	
LAF_DT_LIQUIDACAO as date, 
PES_NU_CPF_CNPJ_PAGADOR as id,
SUM(LAF_VL) as value_sent_to_person_in_mun,
COUNT(LAF_VL) as trans_sent_to_person_in_mun,
TPP_CD_TIPO_PESSOA_PAGADOR as TIPO_PAG,
CLI_PAG.MUN_CD as id_municipio_bcb,
FROM	PIXDWPRO_ACC.SPITB_LAF_LANCAMENTO_FATO PIX
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_PAG
ON (PIX.PES_NU_CPF_CNPJ_PAGADOR = CLI_PAG.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_PAGADOR = CLI_PAG.TPE_CD)
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_REC
ON (PIX.PES_NU_CPF_CNPJ_RECEBEDOR = CLI_REC.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_RECEBEDOR = CLI_REC.TPE_CD)
WHERE
  PES_NU_CPF_CNPJ_PAGADOR != PES_NU_CPF_CNPJ_RECEBEDOR
  AND TPP_CD_TIPO_PESSOA_RECEBEDOR = @PESSOAFISICA
  AND CLI_PAG.MUN_CD = CLI_REC.MUN_CD
  AND LAF_DT_LIQUIDACAO >= @selectedDateSTART AND LAF_DT_LIQUIDACAO < @selectedDateEND
	AND STA_CD_LIQUIDADA = 'S'
	AND STA_CD_REJEICAO = 'N'
	AND LAF_VL > 0.01
  AND 
(
CLI_PAG.MUN_CD in (41117,43359,43029,46882,46875,46868,50830,9465,50919,50964,5184,50847,41636,41629,4642,17756,12438,51444,51406,25542,30180,13293,16362,40950,21838,27210,10643,31330,26149,17354,37798,21591,34258,36689,15411,33163,9795,5270,6712,17392,13932,25535,35604,25164,18315,4446,22813,25085,33981,25377,33424,8480,40613,43380,28051,14852,29287,42350,42453,51107,42336,37585,31787,18504,11178,34818,11350,22181,16805,21168,41344,31866,27100,22954,19644,33503,2307,32243,6042,8545,20767,8349,12689,16427,10296,33819,8875,32580,20406,25236,5823,20695,8222,29995,16771,9032,1937,15239,25030,14058,4941,7876,13750,31495,30843,56281,9252,6781,10382,19163,5191,37293,32683,40211,11673,25267,29476,7591,2730,22019,23159,1016,32308,16458,25140,37231,32676,23630,25298,24660,25645,30283,28927,20035,24419,20592,39387,18700,23104,29548,8765,21481,13808,36847,20217,18164,36012,27021,22686,36005,42587,11642,2998,15095,30647,27193,18384,35147,25566,19493,10674,38821,20949,3069,25573,13372,38807,25281,28635,19709,5799,2637,15291,37626,3461,35783,18243,37774,42271,33651,8253,34588,25786,35721,6444,26912,15208,5744,12926,6262,31189,9719,14890,23843,28295,37286,7292,15064,23836,15985,53002,17299,35068,26053,30568,8868,13327,26682,3791,22253,18061,35611,26589,13877,36218,8040,10193,33606,39215,30939,35563,4460,18157,26967,13633,7034,14522,14429,7979,36696,1308,14333,18762,32205,25119,18755,6884,2503,12184,25308,29830,35202,26235,30692,21852,35185,37372,15150,16094,38319,25346,34423,8459,30070,26266,9403,24907,50421,8442,12218,21034,14041,19778,33170,19682,28587,33060,10863,28604,5397,19967,37705,7687,53693,24378,16142,21058,24316,38395,31828,11408,34485,16678,55945,55952,20774,52436,30087,9441,18023,28714,33235,2321,13107,20231,20619,9953,45876,22112,40022,17086,16403,3667,12720,13884,11415,48866,38759,21694,30551,49016,5713,15961,34296,35099,5218,7333,37145,10454,37262,10540,5593,20987,15758,3258,35075,35020,52766,7106,33802,48567,17952,29483,31471,50005,2084,28680,28642,41265,19950,47678,41272,26383,47692,9111,50043,27526,27502,1346,1243,41131,41124,29184,25009,25511,39208,12500,30142,26534,40352,13626,27131,25896,39473,32982,37413,12995,41454,20451,19840,15590,9434,9812,6107,25700,25683,43287,35491,35831,9609,33572,11271,33493,5809,30898,4903,15710,24684,8741,17031,30290,36469,9977,24691,2479,12658,40039,5050,2826,20815,38632,50641,30386,23348,23403,36885,27887,36919,23427,11422,26644,13286,31141,46033,38797,10571,55660,20176,45065,45072,30221,8679,26761,32810,10650,40802,26778,40826,8538,13860,40833,49229,8411,33998,40864,31206,43043,53947,54654,54661,18346,58296,42903,41100,41155,32872,42824,42817,54685,42893,5775,13028,21948,41416,35350,24323,49425,42800,13114,42886,51554,13891,10320,10313,41674,36737,3571,25913,50160,31488,22727,40503,24237,43861,16348)
)
GROUP BY PES_NU_CPF_CNPJ_PAGADOR, TPP_CD_TIPO_PESSOA_PAGADOR, CLI_PAG.MUN_CD


-- agregando por semana

-- Fixing the week issue so Jan 1, 2021 be the starting of week 1. 
SET DATEFIRST = 5


SELECT	
DATEPART(week, LAF_DT_LIQUIDACAO) AS Week, 
PES_NU_CPF_CNPJ_PAGADOR as id,
SUM(LAF_VL) as value_sent_to_person_in_mun,
COUNT(LAF_VL) as trans_sent_to_person_in_mun,
TPP_CD_TIPO_PESSOA_PAGADOR as TIPO_PAG,
CLI_PAG.MUN_CD as id_municipio_bcb,
FROM	PIXDWPRO_ACC.SPITB_LAF_LANCAMENTO_FATO PIX
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_PAG
ON (PIX.PES_NU_CPF_CNPJ_PAGADOR = CLI_PAG.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_PAGADOR = CLI_PAG.TPE_CD)
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_REC
ON (PIX.PES_NU_CPF_CNPJ_RECEBEDOR = CLI_REC.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_RECEBEDOR = CLI_REC.TPE_CD)
WHERE
  PES_NU_CPF_CNPJ_PAGADOR != PES_NU_CPF_CNPJ_RECEBEDOR
  AND TPP_CD_TIPO_PESSOA_RECEBEDOR = @PESSOAFISICA
  AND CLI_PAG.MUN_CD = CLI_REC.MUN_CD
  AND LAF_DT_LIQUIDACAO >= @selectedDateSTART AND LAF_DT_LIQUIDACAO < @selectedDateEND
	AND STA_CD_LIQUIDADA = 'S'
	AND STA_CD_REJEICAO = 'N'
	AND LAF_VL > 0.01
  AND 
(
CLI_PAG.MUN_CD in (41117,43359,43029,46882,46875,46868,50830,9465,50919,50964,5184,50847,41636,41629,4642,17756,12438,51444,51406,25542,30180,13293,16362,40950,21838,27210,10643,31330,26149,17354,37798,21591,34258,36689,15411,33163,9795,5270,6712,17392,13932,25535,35604,25164,18315,4446,22813,25085,33981,25377,33424,8480,40613,43380,28051,14852,29287,42350,42453,51107,42336,37585,31787,18504,11178,34818,11350,22181,16805,21168,41344,31866,27100,22954,19644,33503,2307,32243,6042,8545,20767,8349,12689,16427,10296,33819,8875,32580,20406,25236,5823,20695,8222,29995,16771,9032,1937,15239,25030,14058,4941,7876,13750,31495,30843,56281,9252,6781,10382,19163,5191,37293,32683,40211,11673,25267,29476,7591,2730,22019,23159,1016,32308,16458,25140,37231,32676,23630,25298,24660,25645,30283,28927,20035,24419,20592,39387,18700,23104,29548,8765,21481,13808,36847,20217,18164,36012,27021,22686,36005,42587,11642,2998,15095,30647,27193,18384,35147,25566,19493,10674,38821,20949,3069,25573,13372,38807,25281,28635,19709,5799,2637,15291,37626,3461,35783,18243,37774,42271,33651,8253,34588,25786,35721,6444,26912,15208,5744,12926,6262,31189,9719,14890,23843,28295,37286,7292,15064,23836,15985,53002,17299,35068,26053,30568,8868,13327,26682,3791,22253,18061,35611,26589,13877,36218,8040,10193,33606,39215,30939,35563,4460,18157,26967,13633,7034,14522,14429,7979,36696,1308,14333,18762,32205,25119,18755,6884,2503,12184,25308,29830,35202,26235,30692,21852,35185,37372,15150,16094,38319,25346,34423,8459,30070,26266,9403,24907,50421,8442,12218,21034,14041,19778,33170,19682,28587,33060,10863,28604,5397,19967,37705,7687,53693,24378,16142,21058,24316,38395,31828,11408,34485,16678,55945,55952,20774,52436,30087,9441,18023,28714,33235,2321,13107,20231,20619,9953,45876,22112,40022,17086,16403,3667,12720,13884,11415,48866,38759,21694,30551,49016,5713,15961,34296,35099,5218,7333,37145,10454,37262,10540,5593,20987,15758,3258,35075,35020,52766,7106,33802,48567,17952,29483,31471,50005,2084,28680,28642,41265,19950,47678,41272,26383,47692,9111,50043,27526,27502,1346,1243,41131,41124,29184,25009,25511,39208,12500,30142,26534,40352,13626,27131,25896,39473,32982,37413,12995,41454,20451,19840,15590,9434,9812,6107,25700,25683,43287,35491,35831,9609,33572,11271,33493,5809,30898,4903,15710,24684,8741,17031,30290,36469,9977,24691,2479,12658,40039,5050,2826,20815,38632,50641,30386,23348,23403,36885,27887,36919,23427,11422,26644,13286,31141,46033,38797,10571,55660,20176,45065,45072,30221,8679,26761,32810,10650,40802,26778,40826,8538,13860,40833,49229,8411,33998,40864,31206,43043,53947,54654,54661,18346,58296,42903,41100,41155,32872,42824,42817,54685,42893,5775,13028,21948,41416,35350,24323,49425,42800,13114,42886,51554,13891,10320,10313,41674,36737,3571,25913,50160,31488,22727,40503,24237,43861,16348)
)
GROUP BY DATEPART(week, LAF_DT_LIQUIDACAO), PES_NU_CPF_CNPJ_PAGADOR, TPP_CD_TIPO_PESSOA_PAGADOR, CLI_PAG.MUN_CD

