-- Pix for Others
-- Agregando por mes

-- Vamos baixar de novembro 2020 ate fim de 2021?
-- Depois queria baixar 2022 tambem para ver efeitos a longo prazo


-- Trocar mes por numero *************************
-- Loop de baixar um arquivo por mes. ao inves de baixar o ano todo e extrair o mes

-- Sending Transactions
SELECT	
EXTRACT(YEAR FROM LAF_DT_LIQUIDACAO) || '-' || EXTRACT(MONTH FROM LAF_DT_LIQUIDACAO) AS month, 
PES_NU_CPF_CNPJ_PAGADOR as id,
SUM(LAF_VL) as value_sent,
COUNT(LAF_VL) as trans_sent,
TPP_CD_TIPO_PESSOA_PAGADOR as TIPO_PAG,
CLI_PAG.MUN_CD as id_municipio_bcb,
FROM	PIXDWPRO_ACC.SPITB_LAF_LANCAMENTO_FATO PIX
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_PAG
ON (PIX.PES_NU_CPF_CNPJ_PAGADOR = CLI_PAG.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_PAGADOR = CLI_PAG.TPE_CD)
WHERE
  PES_NU_CPF_CNPJ_PAGADOR != PES_NU_CPF_CNPJ_RECEBEDOR
  AND LAF_DT_LIQUIDACAO >= @selectedDateSTART AND LAF_DT_LIQUIDACAO < @selectedDateEND
	AND STA_CD_LIQUIDADA = 'S'
	AND STA_CD_REJEICAO = 'N'
  AND CLI_PAG.MUN_CD in (23300,45618,10849,54795,55976,2163,6523,2266,39545,28776,51482,42848,40280,46394,4381,51798,51262,56353,24048,5672,3052,31165,34478,1377,28305,39136,54386,20705,27777,22002,32717,18346,54070,40723,38780,26211,55141,9283,16977,26046,24196,41423,41564,4439,21845,2084,53466,24268,55282,48031,57493,45357,8686,30128,51695,33613,44712,4501,56748,40400,16829,4271,46806,6767,45247,27423,16908,11336,32896,28769,55110,57778,25418,55268,7120,5964,35745,25298,28518,3722,5328,4886,51750,10643,30984,14089,7065,30623,14467,45395,39466,32827,1669,5201,8954,41784,10265,23180,46033,54788,43665,50249,56133,31378,21900,19455,22741,12847,29414,6152,27368,1298,25023,20341,2259,23331,39703,44547,16805,11570,15088,49786,40008,9537,19675,55392,45694,40039,30647,43885,49140,40912,54094,14625,25566,25346,3478,40084,57259,10203,27100,13080,32645,49944,35790,29098,29634,8301,46301,25205,39019,38986,6358,13499,2699,44303,19376,16757,14687,45106,26084,34210,52106,5397,1016,7546,58272,34825,5081,18638,23568,12122,19699,38474,49982,42477,9630,15820,40077,39837,18212,12373,2974,20925,52656,13963,24127,10344,53019,30087,32360,43531,5531,50366,27258,20011,57510,47898,11271,48402,42518,8703,52869,10454,23843,24206,16173,20004,52924,26888,29658,16939,35570,13743,25559,25793,54269,30881,20671,5445,18391,45199,17756,36414,46569,26235,20963,16678,10306,51918,39129,21601,26187,14838,44554,37059,55323,2596,53772,12641,40558,56621,57606,11037,24172,23427,28422,43294,22277,32092,55495,10973,54173,33266,30609,51712,28831,25944,50335,10667,21979,52292,14618,54393,22545,20633,34351,6028,17464,8459,24811,11422,11783,18762,8057,57912,56401,43713,43373,10887,11769,41935,52663,37808,13877,33651,34454,50153,29782,52285,37341,26778,35642,29775,16434,26620,5335,15246,10038,56504,16623,23458,6176,44561,19297,17402,4680,53404,30434,55206,5153,27612,14041,34540,41643,49999,34784,42408,12029,29270,23049,42185,56542,38993,51970,51413,9702,28642,6918,37107,33163,55378,9939,57307,38223,39624,27722,56652,40170,46514,3526,53239,30070,19637,52931,49717,26864,41337,19912,38058,21694,10997,38481,56528,45553,5782,41588,28556,30616,18913,55189,45027,57682,10409,55653,18810,6705,5854,20523,11398,18384,34894,6310,22992,40819,11312,4460,11099,10052,41351,50995,15143,49937,12256,54953,5256,4879,20138,26383,43201,7364,13815,9252,22631,39655,26455,30757,20877,31000,54812,31495,19383,54214,37815,33974,53741,4783,27801,12579,41117,24842,25748,51444,45429,57716,6080,7089,10485,31299,3942,24471,35879,17110,23173,43555,32573,27870,46909,31457,58014,18126,4044,36005,15473,51530,1762,14302,50067,3708,42673,13516,56016,19644,8239,55804,47922,35886,27289,50294,43524,50809,47867,22394,22569,8758,12555,38601,48770,53143,27454,8851,4790,10124,23159,26840,55567,37176,13217,5050,48859,55859,55897,40259,2644,5380,8545,1731,36593,56786,15662,53734,14278,19682,12799,31323,5878,34234,1724,37949,34148,22789,50050,54159,20781,32865,20808,55598,25432,43816,46129)
GROUP BY EXTRACT(YEAR FROM LAF_DT_LIQUIDACAO) || '-' || EXTRACT(MONTH FROM LAF_DT_LIQUIDACAO), PES_NU_CPF_CNPJ_PAGADOR, TPP_CD_TIPO_PESSOA_PAGADOR, CLI_PAG.MUN_CD



-- Receiving Transactions
SELECT	
EXTRACT(YEAR FROM LAF_DT_LIQUIDACAO) || '-' || EXTRACT(MONTH FROM LAF_DT_LIQUIDACAO) AS month, 
PES_NU_CPF_CNPJ_RECEBEDOR as id,
SUM(LAF_VL) as value_received,
COUNT(LAF_VL) as trans_received,
TPP_CD_TIPO_PESSOA_RECEBEDOR as person_or_firm,
CLI_REC.MUN_CD as id_municipio_bcb,
FROM	PIXDWPRO_ACC.SPITB_LAF_LANCAMENTO_FATO PIX
LEFT JOIN PIXDWPRO_ACC.SPIVW_PES_PESSOA_FIS_JUR CLI_REC
ON (PIX.PES_NU_CPF_CNPJ_RECEBEDOR = CLI_REC.PEG_CD_CPF_CNPJ14 AND  PIX.TPP_CD_TIPO_PESSOA_RECEBEDOR = CLI_REC.TPE_CD)
WHERE
  PES_NU_CPF_CNPJ_PAGADOR != PES_NU_CPF_CNPJ_RECEBEDOR
  AND LAF_DT_LIQUIDACAO >= @selectedDateSTART AND LAF_DT_LIQUIDACAO < @selectedDateEND
	AND STA_CD_LIQUIDADA = 'S'
	AND STA_CD_REJEICAO = 'N'
  AND CLI_REC.MUN_CD in (23300,45618,10849,54795,55976,2163,6523,2266,39545,28776,51482,42848,40280,46394,4381,51798,51262,56353,24048,5672,3052,31165,34478,1377,28305,39136,54386,20705,27777,22002,32717,18346,54070,40723,38780,26211,55141,9283,16977,26046,24196,41423,41564,4439,21845,2084,53466,24268,55282,48031,57493,45357,8686,30128,51695,33613,44712,4501,56748,40400,16829,4271,46806,6767,45247,27423,16908,11336,32896,28769,55110,57778,25418,55268,7120,5964,35745,25298,28518,3722,5328,4886,51750,10643,30984,14089,7065,30623,14467,45395,39466,32827,1669,5201,8954,41784,10265,23180,46033,54788,43665,50249,56133,31378,21900,19455,22741,12847,29414,6152,27368,1298,25023,20341,2259,23331,39703,44547,16805,11570,15088,49786,40008,9537,19675,55392,45694,40039,30647,43885,49140,40912,54094,14625,25566,25346,3478,40084,57259,10203,27100,13080,32645,49944,35790,29098,29634,8301,46301,25205,39019,38986,6358,13499,2699,44303,19376,16757,14687,45106,26084,34210,52106,5397,1016,7546,58272,34825,5081,18638,23568,12122,19699,38474,49982,42477,9630,15820,40077,39837,18212,12373,2974,20925,52656,13963,24127,10344,53019,30087,32360,43531,5531,50366,27258,20011,57510,47898,11271,48402,42518,8703,52869,10454,23843,24206,16173,20004,52924,26888,29658,16939,35570,13743,25559,25793,54269,30881,20671,5445,18391,45199,17756,36414,46569,26235,20963,16678,10306,51918,39129,21601,26187,14838,44554,37059,55323,2596,53772,12641,40558,56621,57606,11037,24172,23427,28422,43294,22277,32092,55495,10973,54173,33266,30609,51712,28831,25944,50335,10667,21979,52292,14618,54393,22545,20633,34351,6028,17464,8459,24811,11422,11783,18762,8057,57912,56401,43713,43373,10887,11769,41935,52663,37808,13877,33651,34454,50153,29782,52285,37341,26778,35642,29775,16434,26620,5335,15246,10038,56504,16623,23458,6176,44561,19297,17402,4680,53404,30434,55206,5153,27612,14041,34540,41643,49999,34784,42408,12029,29270,23049,42185,56542,38993,51970,51413,9702,28642,6918,37107,33163,55378,9939,57307,38223,39624,27722,56652,40170,46514,3526,53239,30070,19637,52931,49717,26864,41337,19912,38058,21694,10997,38481,56528,45553,5782,41588,28556,30616,18913,55189,45027,57682,10409,55653,18810,6705,5854,20523,11398,18384,34894,6310,22992,40819,11312,4460,11099,10052,41351,50995,15143,49937,12256,54953,5256,4879,20138,26383,43201,7364,13815,9252,22631,39655,26455,30757,20877,31000,54812,31495,19383,54214,37815,33974,53741,4783,27801,12579,41117,24842,25748,51444,45429,57716,6080,7089,10485,31299,3942,24471,35879,17110,23173,43555,32573,27870,46909,31457,58014,18126,4044,36005,15473,51530,1762,14302,50067,3708,42673,13516,56016,19644,8239,55804,47922,35886,27289,50294,43524,50809,47867,22394,22569,8758,12555,38601,48770,53143,27454,8851,4790,10124,23159,26840,55567,37176,13217,5050,48859,55859,55897,40259,2644,5380,8545,1731,36593,56786,15662,53734,14278,19682,12799,31323,5878,34234,1724,37949,34148,22789,50050,54159,20781,32865,20808,55598,25432,43816,46129)
GROUP BY EXTRACT(YEAR FROM LAF_DT_LIQUIDACAO) || '-' || EXTRACT(MONTH FROM LAF_DT_LIQUIDACAO), PES_NU_CPF_CNPJ_RECEBEDOR, TPP_CD_TIPO_PESSOA_RECEBEDOR, CLI_REC.MUN_CD

