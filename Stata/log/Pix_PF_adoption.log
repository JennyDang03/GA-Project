------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  \\sbcdf176\PIX_Matheus$\Stata\log\Pix_PF_adoption.log
  log type:  text
 opened on:  13 Apr 2023, 18:38:15

. 
. * carrega arquivo somente de quem teve aux emergencial em abril 21 e está nos 5000 menores municipios 
. use "$dta\Pix_individuo_aux_abr21.dta", replace 

. 
. gen time = mdy(time_id - int(time_id/100) * 100,1 ,int(time_id/100) )

. drop time_id

. gen time_id = mofd( time)

. format %tmNN/CCYY time_id

. tab time_id

    time_id |      Freq.     Percent        Cum.
------------+-----------------------------------
    11/2020 |    496,092        0.42        0.42
    12/2020 |  1,474,878        1.24        1.66
    01/2021 |  1,449,972        1.22        2.87
    02/2021 |  1,705,251        1.43        4.31
    03/2021 |  2,160,570        1.82        6.12
    04/2021 |  2,737,056        2.30        8.42
    05/2021 |  3,793,770        3.19       11.61
    06/2021 |  4,285,226        3.60       15.21
    07/2021 |  4,824,082        4.05       19.26
    08/2021 |  5,077,328        4.27       23.53
    09/2021 |  5,047,870        4.24       27.77
    10/2021 |  5,495,532        4.62       32.38
    11/2021 |  4,932,358        4.14       36.53
    12/2021 |  4,837,845        4.06       40.59
    01/2022 |  4,924,378        4.14       44.73
    02/2022 |  5,071,774        4.26       48.99
    03/2022 |  5,318,541        4.47       53.46
    04/2022 |  5,499,211        4.62       58.08
    05/2022 |  5,707,364        4.79       62.87
    06/2022 |  5,855,540        4.92       67.79
    07/2022 |  6,030,132        5.07       72.86
    08/2022 |  6,211,328        5.22       78.07
    09/2022 |  6,336,028        5.32       83.40
    10/2022 |  6,480,662        5.44       88.84
    11/2022 |  6,556,069        5.51       94.35
    12/2022 |  6,727,236        5.65      100.00
------------+-----------------------------------
      Total |119,036,093      100.00

. drop time 

. 
. * Elimina quem tem registros em diferentes municipios. 
. duplicates tag id time_id, gen(dup)

Duplicates in terms of id time_id

. tab dup

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |119,035,441      100.00      100.00
          1 |        652        0.00      100.00
------------+-----------------------------------
      Total |119,036,093      100.00

. drop if dup == 1
(652 observations deleted)

. drop dup

. 
. * elimina variaveis nao usadas -------------------------------------------------
. * drop value_sent value_rec index0 
. drop index0

. 
. * Cria painel balanceado
. sort id muni_cd time_id

. tsset id time_id

Panel variable: id (unbalanced)
 Time variable: time_id, 11/2020 to 12/2022, but with gaps
         Delta: 1 month

. tsfill, full

. 
. replace trans_rec = 0 if trans_rec == .
(116,174,209 real changes made)

. replace trans_sent = 0 if trans_sent == .
(116,174,209 real changes made)

. 
. * preenche tambem index 
. bysort id: egen indexT = max(index) 

. replace index = indexT if index == .
(116,174,209 real changes made)

. 
. * Create Pix Adoption 
. *gen dummy_rec = 0
. *gen dummy_sent = 0
. *replace dummy_rec = 1 if trans_rec > 0
. *replace dummy_sent = 1 if trans_sent > 0
. 
. * Identifying time of first pix of the person
. * first pix has the date of the first pix o the that person
. bysort id : egen temp = min(time_id) if trans_rec > 0
(134,271,498 missing values generated)

. bysort id : egen date_first_pix_rec = max(temp) 
(30,009,746 missing values generated)

. drop temp 

. 
. bysort id : egen temp = min(time_id) if trans_sent > 0 
(138,115,410 missing values generated)

. bysort id : egen date_first_pix_sent = max(temp) 
(19,384,404 missing values generated)

. drop temp 

. 
. format %tmNN/CCYY date_first_pix_rec

. format %tmNN/CCYY date_first_pix_sent

. 
. * This flags if the date time_id is before or after the first pix transaction
. gen after_first_pix_rec = time_id > date_first_pix_rec

. gen after_first_pix_sent = time_id > date_first_pix_sent

. 
. *Save only Adoption ------------------------------------------------------------
. keep id index time_id after_first_pix_rec after_first_pix_sent ///
>         date_first_pix_rec date_first_pix_sent muni_cd ///
>         trans_rec trans_sent value_sent value_rec

. 
. * Temos que adicionar os que nunca usaram Pix.  São cerca de 260k
. * Esses id's estão no arquivo "$dta\id_aux_abril21_sem_pix.dta"
. 
. merge m:1 id using "$dta\id_aux_abril21_sem_pix.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                   235,474,203
        from master               235,209,650  (_merge==1)
        from using                    264,553  (_merge==2)

    Matched                                 0  (_merge==3)
    -----------------------------------------

. replace time_id = 730 if _merge == 2
(264,553 real changes made)

. replace after_first_pix_sent = 0 if _merge == 2
(264,553 real changes made)

. replace after_first_pix_rec = 0 if _merge == 2
(264,553 real changes made)

. drop _merge 

. 
. sort id time_id

. tsset id time_id

Panel variable: id (unbalanced)
 Time variable: time_id, 11/2020 to 12/2022
         Delta: 1 month

. tsfill, full

. 
. replace after_first_pix_sent = 0 if after_first_pix_sent == .
(6,613,825 real changes made)

. replace after_first_pix_rec  = 0 if after_first_pix_rec  == .
(6,613,825 real changes made)

. replace trans_rec  = 0 if trans_rec  == .
(6,878,378 real changes made)

. replace trans_sent  = 0 if trans_sent  == .
(6,878,378 real changes made)

. replace value_sent  = 0 if value_sent  == .
(123,052,587 real changes made)

. replace value_rec  = 0 if value_rec  == .
(123,052,587 real changes made)

. 
. * Adiciona dados da localizacao e distancias
. * por enquanto, somente uma amostra 
. *merge m:1 index using "$dta\aux_address_partial_results7_super_cleaned.dta"
. merge m:1 index using "$dta\dist_caixa_multiprocess7.dta"
(variable index was long, now double to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                   228,337,690
        from master               228,080,899  (_merge==1)
        from using                    256,791  (_merge==2)

    Matched                        14,007,129  (_merge==3)
    -----------------------------------------

. 
. keep if _merge == 3
(228,337,690 observations deleted)

. drop _merge 

. sum *

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          id | 14,007,129    4.99e+08    2.88e+08        308   1.00e+09
     muni_cd |  7,042,174    26404.01    15003.38       1009      58375
   value_rec | 14,007,129    1048.188    6013.744          0    4746395
   trans_rec | 14,007,129     4.47773    24.72315          0      54297
  value_sent | 14,007,129    909.8838    6077.627          0    5236046
-------------+---------------------------------------------------------
  trans_sent | 14,007,129    4.505263    11.77371          0       1745
       index | 14,007,129     5384742     3124413         10   1.08e+07
     time_id | 14,007,129    742.4858    7.507565        730        755
date_first~c | 12,190,698    739.0461    6.807355        730        755
date_first~t | 12,817,350    738.9754    6.537094        730        755
-------------+---------------------------------------------------------
after_firs~c | 14,007,129      .53404      .49884          0          1
after_firs~t | 14,007,129    .5639788    .4958898          0          1
      index0 | 14,007,129     5384743     3124413         10   1.08e+07
    latitude | 14,007,129   -14.26695    8.062566  -33.73692   5.207775
   longitude | 14,007,129   -45.11041    6.725792  -73.45826  -32.40663
-------------+---------------------------------------------------------
  confidence | 14,007,129    7.904017    .9433796          7         10
      mun_cd | 14,007,129    26295.71    15000.67       1009      58375
  dist_caixa | 14,007,129    4.155385    13.19138   .0008129   406.1721
dist_other~k | 14,007,129    3.835809    11.49609   .0003983   324.3878
   dist_bank | 14,007,129    2.873122    10.12047   .0003983   324.3878
-------------+---------------------------------------------------------
expected_d~e | 14,007,129    5.455708    11.51097   .0256739    337.013

. unique index
Number of unique values of index is  392979
Number of records is  14007129

. unique id
Number of unique values of id is  554054
Number of records is  14007129

. 
. *gen after_event  =  time_id >= mofd(mdy(4, 30, 2021))
. 
. gen after_first_pix = min(after_first_pix_rec, after_first_pix_sent)

. 
. merge m:1 id using "$dta\id_mes_auxilio_jan_mar_21.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                    14,063,035
        from master                14,002,342  (_merge==1)
        from using                     60,693  (_merge==2)

    Matched                             4,787  (_merge==3)
    -----------------------------------------

. gen aux_emerg_jan_mar21 = (_merge == 3)

. drop _merge

. 
. * Adiciona status de BF, extracad, cad
. merge m:1 id using "\\sbcdf176\PIX_Matheus$\Stata\dta\cpf_bolsa_familia.dta", keep(1 3) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                        57,453
        from master                    57,453  
        from using                          0  

    Matched                        14,010,369  
    -----------------------------------------

. 
. save "$dta\Pix_PF_adoption.dta", replace 
file \\sbcdf176\PIX_Matheus$\Stata\dta\Pix_PF_adoption.dta saved

. 
. log close
      name:  <unnamed>
       log:  \\sbcdf176\PIX_Matheus$\Stata\log\Pix_PF_adoption.log
  log type:  text
 closed on:  13 Apr 2023, 19:19:51
------------------------------------------------------------------------------------------------------------------
